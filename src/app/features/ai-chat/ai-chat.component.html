<!-- Chat Toggle Button (Widget Mode) -->
@if (!isPageMode()) {
    <button
      #toggleBtn
      (click)="toggleChat()"
      class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-linear-to-br from-third-custom to-fourth-custom text-white shadow-lg hover:shadow-2xl hover:scale-110 active:scale-95 transition-all duration-300 flex items-center justify-center group ring-2 ring-white/20"
      aria-label="Toggle AI Assistant Chat"
    >
      @if (!isOpen()) {
      <svg
        class="w-7 h-7 group-hover:rotate-12 transition-transform duration-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
        ></path>
      </svg>
      } @else {
      <svg class="w-6 h-6 rotate-0 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"
        ></path>
      </svg>
      }
    </button>
    }
    
    <!-- Chat Window Container -->
    @if (isOpen()) {
    <div
      class="fixed z-40 flex flex-col overflow-hidden transition-all duration-300 ease-out"
      [class]="isPageMode() 
        ? 'relative w-full h-full bg-white/30 dark:bg-black/30 backdrop-blur-2xl rounded-3xl border border-white/20 shadow-2xl' 
        : 'fixed bottom-24 right-6 w-[400px] max-w-[calc(100vw-3rem)] h-[600px] max-h-[calc(100vh-8rem)] bg-white/80 dark:bg-neutral-900/80 backdrop-blur-2xl rounded-3xl border border-white/20 shadow-2xl ring-1 ring-black/5'"
    >
      
      <!-- Layout Container -->
      <div class="flex h-full w-full">
        
        <!-- Sidebar (Page Mode Only) -->
        @if (isPageMode()) {
        <aside 
            class="w-80 shrink-0 border-r border-white/10 bg-white/40 dark:bg-black/20 backdrop-blur-md flex flex-col transition-all duration-300"
            [class.translate-x-0]="isSidebarOpen()"
            [class.-translate-x-full]="!isSidebarOpen()"
        >
          <!-- Sidebar Header -->
          <div class="p-4 border-b border-white/10">
            <button
              (click)="createNewSession()"
              class="w-full py-3 px-4 bg-linear-to-r from-third-custom to-first-custom text-white rounded-xl shadow-lg hover:shadow-indigo-500/30 hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 flex items-center justify-center gap-2 font-medium"
            >
              <ng-icon class="w-5 h-5 size-6!" name="matAddRound"></ng-icon>
              <span>New Chat</span>
            </button>
          </div>
    
          <!-- Session List -->
          <div class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
            <div class="px-2 py-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Recent Conversations</div>
            @for (session of sessions(); track session.id) {
            <div
              (click)="selectSession(session.id)"
              class="group relative flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all duration-200 border border-transparent hover:border-white/10"
              [class.bg-white/60]="currentSessionId() === session.id"
              [class.dark:bg-white/10]="currentSessionId() === session.id"
              [class.shadow-sm]="currentSessionId() === session.id"
              [class.hover:bg-white/40]="currentSessionId() !== session.id"
              [class.dark:hover:bg-white/5]="currentSessionId() !== session.id"
            >
              <div class="shrink-0 w-8 h-8 rounded-lg bg-linear-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-900 flex items-center justify-center text-gray-500">
                <ng-icon class="text-gray-500!" name="matChatRound"></ng-icon>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="text-sm font-medium text-gray-800 dark:text-gray-200 truncate">{{ session.title }}</h4>
                <p class="text-[10px] text-gray-500 dark:text-gray-400 mt-0.5">{{ session.updatedAt | date : 'MMM d, h:mm a' }}</p>
              </div>
              
              <!-- Delete Button -->
              <button
                (click)="deleteSession(session.id, $event)"
                class="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-all"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
            }
          </div>
        </aside>
        }
    
        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col min-w-0 bg-white/50 dark:bg-neutral-900/50 relative">
          
          <!-- Header -->
          <header class="shrink-0 px-6 py-4 border-b border-white/10 bg-white/40 dark:bg-black/20 backdrop-blur-md flex items-center justify-between z-10">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 rounded-xl bg-linear-to-br from-third-custom to-first-custom p-[1px] shadow-lg shadow-first-custom/20">
                <div class="w-full h-full rounded-[10px] bg-white dark:bg-neutral-900 flex items-center justify-center">
                    <svg class="w-5 h-5 text-transparent bg-clip-text bg-linear-to-br from-third-custom to-first-custom" fill="none" stroke="url(#gradient)" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#f4631e" />
                                <stop offset="100%" stop-color="#309898" />
                            </linearGradient>
                        </defs>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
              </div>
              <div>
                <h2 class="text-base font-bold text-gray-900 dark:text-white tracking-tight">AI Assistant</h2>
                <div class="flex items-center gap-1.5">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Online</span>
                </div>
              </div>
            </div>
    
            <!-- Model Selector -->
            <div class="relative group">
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <select
                  [ngModel]="selectedCredentialId()"
                  (ngModelChange)="selectedCredentialId.set($event)"
                  class="appearance-none bg-white/50 dark:bg-black/20 border border-gray-200 dark:border-white/10 text-gray-700 dark:text-gray-200 text-xs font-medium rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:ring-2 focus:ring-first-custom/50 transition-all cursor-pointer hover:bg-white/80 dark:hover:bg-black/40"
                >
                  @for (provider of availableProviders(); track provider.credentialId) {
                  <option 
                    [value]="provider.credentialId" 
                  >
                  {{ provider.name }}
                  </option>
                  }
                </select>
            </div>
          </header>
    
          <!-- Messages Viewport -->
          <div class="flex-1 min-h-0 relative flex flex-col">
           <cdk-virtual-scroll-viewport 
              [itemSize]="150" 
              class="flex-1 w-full custom-scrollbar"
              style="display: block; height: 100%;"
              (scrolledIndexChange)="onScrollIndexChanged($event)"
              #scrollContainer
            >
              <!-- Empty State -->
              @if (messages().length === 0) {
              <div class="h-full flex flex-col items-center justify-center p-8 text-center">
                <div class="w-24 h-24 rounded-3xl bg-linear-to-br from-indigo-500/10 to-pink-500/10 flex items-center justify-center mb-6">
                    <svg class="w-12 h-12 text-indigo-500/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">How can I help you today?</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 max-w-xs mx-auto mb-8">
                    I can help you draft posts, analyze your performance, or answer questions about your data.
                </p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-md">
                    <button (click)="currentMessage.set('Draft a viral tweet about AI'); sendMessage()" class="p-4 rounded-xl bg-white/60 dark:bg-white/5 border border-white/20 hover:border-indigo-500/50 hover:bg-white/80 dark:hover:bg-white/10 transition-all text-left group">
                        <span class="block text-xs font-semibold text-indigo-600 dark:text-indigo-400 mb-1">Draft Post</span>
                        <span class="block text-sm text-gray-700 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">Write a viral tweet about AI...</span>
                    </button>
                    <button (click)="currentMessage.set('Analyze my top performing posts'); sendMessage()" class="p-4 rounded-xl bg-white/60 dark:bg-white/5 border border-white/20 hover:border-pink-500/50 hover:bg-white/80 dark:hover:bg-white/10 transition-all text-left group">
                        <span class="block text-xs font-semibold text-pink-600 dark:text-pink-400 mb-1">Analyze</span>
                        <span class="block text-sm text-gray-700 dark:text-gray-300 group-hover:text-pink-600 dark:group-hover:text-pink-400 transition-colors">Check my top posts...</span>
                    </button>
                </div>
              </div>
              }
    
              <!-- Message List -->
              <div *cdkVirtualFor="let msg of messages(); trackBy: trackByTimestamp" class="px-6 py-4">
                <div class="flex gap-4 max-w-3xl mx-auto" [class.flex-row-reverse]="msg.role === 'user'">
                    <!-- Avatar -->
                    <div class="shrink-0 w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold shadow-md"
                        [class.bg-linear-to-br]="true"
                        [class.from-first-custom]="msg.role === 'assistant'"
                        [class.to-third-custom]="msg.role === 'assistant'"
                        [class.text-white]="msg.role === 'assistant'"
                        [class.bg-gray-200]="msg.role === 'user'"
                        [class.dark:bg-neutral-700]="msg.role === 'user'"
                        [class.text-gray-600]="msg.role === 'user'"
                        [class.dark:text-gray-300]="msg.role === 'user'"
                    >
                        {{ msg.role === 'assistant' ? 'AI' : 'Me' }}
                    </div>
    
                    <!-- Bubble -->
                    <div class="relative max-w-[85%]">
                        <div 
                            class="p-4 rounded-2xl shadow-sm text-sm leading-relaxed"
                            [class.bg-white]="msg.role === 'assistant'"
                            [class.dark:bg-neutral-800]="msg.role === 'assistant'"
                            [class.text-gray-800]="msg.role === 'assistant'"
                            [class.dark:text-gray-200]="msg.role === 'assistant'"
                            [class.rounded-tl-none]="msg.role === 'assistant'"
                            [class.bg-gradient-to-br]="msg.role === 'user'"
                            [class.from-third-custom]="msg.role === 'user'"
                            [class.to-fourth-custom]="msg.role === 'user'"
                            [class.text-white]="msg.role === 'user'"
                            [class.rounded-tr-none]="msg.role === 'user'"
                            [class.shadow-indigo-500/20]="msg.role === 'user'"
                        >
                            @if (msg.role === 'assistant') {
                                <markdown [data]="msg.content" class="prose dark:prose-invert max-w-none text-sm"></markdown>
                            } @else {
                                <p class="whitespace-pre-wrap">{{ msg.content }}</p>
                            }
                        </div>
                        <span class="text-[10px] text-gray-400 mt-1 block px-1" [class.text-right]="msg.role === 'user'">
                            {{ msg.timestamp | date : 'shortTime' }}
                        </span>
                    </div>
                </div>
              </div>
    
              <!-- Loading State -->
              @if (isLoading()) {
              <div class="px-6 py-4">
                <div class="flex gap-4 max-w-3xl mx-auto">
                    <div class="shrink-0 w-8 h-8 rounded-lg bg-linear-to-br from-first-custom to-fourth-custom text-white flex items-center justify-center text-xs font-bold shadow-md">
                        AI
                    </div>
                    <div class="bg-white dark:bg-neutral-800 rounded-2xl rounded-tl-none p-4 shadow-sm flex items-center gap-1.5">
                        <div class="w-2 h-2 bg-first-custom rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-fourth-custom rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-third-custom rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
              </div>
              }
              
              <!-- Spacer for bottom input -->
              <div class="h-4"></div>
            </cdk-virtual-scroll-viewport>
          </div>
    
          <!-- Input Area -->
          <footer class="shrink-0 p-4 bg-white/60 dark:bg-black/40 backdrop-blur-md border-t border-white/10">
            <div class="max-w-3xl mx-auto relative">
                <div class="relative bg-white dark:bg-neutral-800 rounded-2xl shadow-lg shadow-gray-200/50 dark:shadow-black/20 border border-gray-200 dark:border-white/10 p-2 flex items-end gap-2 transition-all focus-within:ring-2 focus-within:ring-first-custom/20 focus-within:border-first-custom/50">
                    <textarea
                      [(ngModel)]="currentMessage"
                      (keydown.enter)="$event.preventDefault(); sendMessage()"
                      placeholder="Type your message..."
                      rows="1"
                      class="w-full pl-3 py-3 max-h-32 bg-transparent border-none focus:ring-0 text-sm text-gray-900 dark:text-white placeholder-gray-400 resize-none custom-scrollbar"
                      [disabled]="isLoading()"
                      style="min-height: 44px;"
                    ></textarea>
                    
                    <button
                      (click)="sendMessage()"
                      [disabled]="!currentMessage().trim() || isLoading()"
                      class="flex items-center justify-center p-2.5 rounded-xl bg-linear-to-r from-third-custom to-fourth-custom text-white shadow-md hover:shadow-lg hover:shadow-indigo-500/30 hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:shadow-none mb-0.5"
                    >
                      <ng-icon name="matSend"></ng-icon>
                    </button>
                </div>
                <p class="text-[10px] text-center text-gray-400 mt-2">
                    AI can make mistakes. Please verify important information.
                </p>
            </div>
          </footer>
    
        </main>
      </div>
    </div>
    }

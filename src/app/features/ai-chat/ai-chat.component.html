<!-- Chat Toggle Button (Only in Widget Mode) -->
@if (!isPageMode()) {
<button
  #toggleBtn
  (click)="toggleChat()"
  class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center justify-center group"
  aria-label="Toggle AI Assistant Chat"
>
  @if (!isOpen()) {
  <svg
    class="w-8 h-8 group-hover:rotate-12 transition-transform duration-300"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
    ></path>
  </svg>
  } @else {
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M6 18L18 6M6 6l12 12"
    ></path>
  </svg>
  }
</button>
}

<!-- Chat Window -->
@if (isOpen()) {
<section
  #chatWindow
  [class]="
    isPageMode()
      ? 'w-full h-full flex bg-white/80 dark:bg-neutral-900/80 backdrop-blur-xl rounded-2xl shadow-sm border border-white/20 overflow-hidden'
      : 'fixed bottom-24 right-6 z-50 w-96 h-[600px] bg-white/90 dark:bg-neutral-900/90 backdrop-blur-xl rounded-2xl shadow-2xl flex flex-col border border-white/20 overflow-hidden ring-1 ring-black/5'
  "
  role="dialog"
  aria-labelledby="chat-title"
>
  <!-- Sidebar (Only in Page Mode) -->
  @if (isPageMode()) {
  <aside class="w-72 bg-gray-50/50 dark:bg-neutral-900/50 border-r border-gray-200/50 dark:border-white/10 flex flex-col backdrop-blur-sm">
    <div class="p-4">
      <button
        (click)="createNewSession()"
        class="w-full py-2.5 px-4 bg-white dark:bg-neutral-800 text-gray-900 dark:text-white rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 hover:border-blue-500 dark:hover:border-blue-500 transition-all duration-200 flex items-center justify-center gap-2 group"
      >
        <div class="w-6 h-6 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center group-hover:scale-110 transition-transform">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
        </div>
        <span class="font-medium text-sm">New Chat</span>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto px-3 space-y-1 custom-scrollbar">
      <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Recent Chats</div>
      @for (session of sessions(); track session.id) {
      <div
        (click)="selectSession(session.id)"
        class="group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all duration-200 border border-transparent"
        [class.bg-white]="currentSessionId() === session.id"
        [class.dark:bg-neutral-800]="currentSessionId() === session.id"
        [class.shadow-sm]="currentSessionId() === session.id"
        [class.border-gray-100]="currentSessionId() === session.id"
        [class.dark:border-neutral-700]="currentSessionId() === session.id"
        [class.hover:bg-gray-100/50]="currentSessionId() !== session.id"
        [class.dark:hover:bg-white/5]="currentSessionId() !== session.id"
      >
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-gray-700 dark:text-gray-200 truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">{{ session.title }}</p>
          <p class="text-[10px] text-gray-400 mt-0.5">{{ session.updatedAt | date : 'MMM d, h:mm a' }}</p>
        </div>
        <button
          (click)="deleteSession(session.id, $event)"
          class="opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all"
        >
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </button>
      </div>
      }
    </div>
  </aside>
  }

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col h-full min-w-0 bg-white/50 dark:bg-neutral-900/50 relative">
    <!-- Header -->
    <header
      class="px-6 py-4 bg-white/80 dark:bg-neutral-900/80 backdrop-blur-md border-b border-gray-100 dark:border-white/5 flex items-center justify-between gap-3 shrink-0 z-10"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-violet-600 flex items-center justify-center shadow-lg shadow-blue-500/20 text-white"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
        <div>
          <h3 id="chat-title" class="font-bold text-base text-gray-900 dark:text-white">AI Assistant</h3>
          <div class="flex items-center gap-1.5">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
            </span>
            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Online & Ready</span>
          </div>
        </div>
      </div>

      <!-- Provider Selector -->
      <div class="relative group">
        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500 dark:text-gray-400">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </div>
        <select
          [(ngModel)]="selectedProvider"
          class="appearance-none bg-gray-100 dark:bg-neutral-800 border border-transparent hover:border-gray-200 dark:hover:border-neutral-700 text-gray-700 dark:text-gray-200 text-xs font-medium rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all cursor-pointer"
        >
          @for (provider of availableProviders; track provider.id) {
          <option 
            [value]="provider.id" 
            [disabled]="!isProviderAvailable(provider.id)"
            [class.text-red-500]="!isProviderAvailable(provider.id)"
            [class.dark:text-red-400]="!isProviderAvailable(provider.id)"
          >
            {{ provider.name }} {{ !isProviderAvailable(provider.id) ? '(Missing Credentials)' : '' }}
          </option>
          }
        </select>
      </div>
    </header>

    <!-- Messages Area -->
    <main #scrollContainer class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
      @if (messages().length === 0) {
      <div class="h-full flex flex-col items-center justify-center text-center space-y-6 p-8">
        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-blue-50 to-violet-50 dark:from-blue-900/20 dark:to-violet-900/20 flex items-center justify-center shadow-inner">
          <svg class="w-10 h-10 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
        </div>
        <div class="max-w-xs">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">How can I help you?</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">I can help you create posts, analyze insights, or answer questions about your data.</p>
        </div>
        <div class="grid grid-cols-1 gap-2 w-full max-w-xs">
            <button (click)="currentMessage.set('Draft a tweet about AI'); sendMessage()" class="text-xs text-left p-3 rounded-xl bg-white dark:bg-neutral-800 border border-gray-100 dark:border-neutral-700 hover:border-blue-500 dark:hover:border-blue-500 hover:shadow-md transition-all text-gray-600 dark:text-gray-300">
                âœ¨ Draft a tweet about AI
            </button>
            <button (click)="currentMessage.set('Show me my recent post performance'); sendMessage()" class="text-xs text-left p-3 rounded-xl bg-white dark:bg-neutral-800 border border-gray-100 dark:border-neutral-700 hover:border-blue-500 dark:hover:border-blue-500 hover:shadow-md transition-all text-gray-600 dark:text-gray-300">
                ðŸ“Š Show post performance
            </button>
        </div>
      </div>
      } @for (msg of messages(); track msg.timestamp) {
      <article class="message-item flex gap-4 group" [class.flex-row-reverse]="msg.role === 'user'">
        <!-- Avatar -->
        <div
          class="w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center text-xs font-bold shadow-sm"
          [class.bg-gradient-to-br]="true"
          [class.from-blue-500]="msg.role === 'assistant'"
          [class.to-violet-600]="msg.role === 'assistant'"
          [class.text-white]="msg.role === 'assistant'"
          [class.bg-gray-200]="msg.role === 'user'"
          [class.dark:bg-neutral-700]="msg.role === 'user'"
          [class.text-gray-600]="msg.role === 'user'"
          [class.dark:text-gray-300]="msg.role === 'user'"
        >
          {{ msg.role === 'assistant' ? 'AI' : 'Me' }}
        </div>

        <!-- Message Bubble -->
        <div
          class="max-w-[85%] rounded-2xl p-4 text-sm shadow-sm relative group-hover:shadow-md transition-shadow"
          [class.bg-white]="msg.role === 'assistant'"
          [class.dark:bg-neutral-800]="msg.role === 'assistant'"
          [class.text-gray-700]="msg.role === 'assistant'"
          [class.dark:text-gray-200]="msg.role === 'assistant'"
          [class.rounded-tl-none]="msg.role === 'assistant'"
          [class.bg-gradient-to-br]="msg.role === 'user'"
          [class.from-blue-600]="msg.role === 'user'"
          [class.to-violet-600]="msg.role === 'user'"
          [class.text-white]="msg.role === 'user'"
          [class.rounded-tr-none]="msg.role === 'user'"
        >
          <p class="whitespace-pre-wrap leading-relaxed">{{ msg.content }}</p>
          <time class="text-[10px] opacity-60 mt-2 block font-medium">
            {{ msg.timestamp | date : 'shortTime' }}
          </time>
        </div>
      </article>
      }

      <!-- Loading Indicator -->
      @if (isLoading()) {
      <div class="message-item flex gap-4">
        <div
          class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-violet-600 text-white flex items-center justify-center text-xs font-bold shadow-sm"
        >
          AI
        </div>
        <div class="bg-white dark:bg-neutral-800 rounded-2xl rounded-tl-none p-4 shadow-sm flex gap-1.5 items-center border border-gray-50 dark:border-white/5">
          <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
          <div
            class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
            style="animation-delay: 0.1s"
          ></div>
          <div
            class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
            style="animation-delay: 0.2s"
          ></div>
        </div>
      </div>
      }
    </main>

    <!-- Input Area -->
    <footer class="p-4 shrink-0">
      <div class="relative bg-white dark:bg-neutral-800 rounded-2xl shadow-lg shadow-gray-200/50 dark:shadow-black/20 border border-gray-100 dark:border-white/5 p-2 flex items-end gap-2 transition-shadow focus-within:shadow-xl focus-within:ring-1 focus-within:ring-blue-500/20">
        <textarea
          [(ngModel)]="currentMessage"
          (keydown.enter)="$event.preventDefault(); sendMessage()"
          placeholder="Type a message..."
          rows="1"
          class="w-full pl-3 py-3 max-h-32 bg-transparent border-none focus:ring-0 text-sm text-gray-900 dark:text-white placeholder-gray-400 resize-none custom-scrollbar"
          [disabled]="isLoading()"
          style="min-height: 44px;"
        ></textarea>
        <button
          (click)="sendMessage()"
          [disabled]="!currentMessage().trim() || isLoading()"
          class="p-2.5 rounded-xl bg-gradient-to-r from-blue-600 to-violet-600 text-white shadow-md hover:shadow-lg hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:shadow-none mb-0.5"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
        </button>
      </div>
      <div class="text-center mt-2">
        <p class="text-[10px] text-gray-400 dark:text-gray-500">AI can make mistakes. Please verify important information.</p>
      </div>
    </footer>
  </div>
</section>
}
